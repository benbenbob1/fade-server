<!DOCTYPE html>
<html>
<head>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
<script src='/js/jscolor.min.js'></script>
<script src='/js/socketio/socket.io.js'></script>
<script src='https://code.jquery.com/jquery-2.2.0.min.js'></script>
<link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
<style type='text/css'>

    html {
        height: 95%;
    }

    body {
        background: #666;
        color: #ddd;
        font-size: 15px;
        font-family: 'Montserrat', sans-serif;
        text-align: center;
        height: 100%;
        overflow: hidden;
    }

    h1 {
    	margin: 30px auto 30px auto;
    }

    button {
        cursor: pointer;
    }

    button.jscolor:hover {
        cursor: pointer;
    	box-shadow: 0px 3px 0px 0px rgba(61,199,34,0.75);
    	margin-top: 3px;
        margin-bottom: -3px;
    }

    .jscolor:focus {
        margin-top: 3px;
        margin-bottom: -3px;
    }

    button:focus {
        outline: none;
    }

    button.jscolor:focus {
    	box-shadow: inset 0px 0px 30px 0px rgba(0,0,0,0.75);
    }

    button:disabled {
        box-shadow: none;
        margin-top: 3px;
        margin-bottom: -2px;
        background-color: darkgrey;
    }

    button.jscolor {
    	transition: 0.05s linear all;
        border-radius: 5px;
        border: none;
        box-shadow: 0px 6px 0px 0px rgba(61,199,34,0.75);
    }

    #main {
        position: relative;
        display: flex;
        width: 100%;
        justify-content: center;
    }

    .flexible-space {
    	width: 70px;
    }

    #lock-strips {
        position: relative;
        background-size: contain;
        height: 40px;
        width: 40px;
        margin: 36px auto 30px auto;
        cursor: pointer;
    }

    .strips {
    	max-width: 420px;
	    min-width: 220px;
    	flex-grow: 1;
    }

    .jscolor:first-child {
    	z-index: 1;
    }

    .jscolor:nth-child(n+2) {
    	z-index: 0;
        width: 2
    }

    .jscolor {
        position: relative;
        max-width: 80%;
        height: 60px;
        width: 280px;
        text-align: center;
        font-size: 30px;
        font-family: 'Montserrat', sans-serif;
        transition: 0.4s ease-in-out top;
    }

    .jscolor-error {
        box-shadow: 0px 10px 0px 0px rgba(204,50,50,0.75);
    }

    .strip-button {

    }

    .button-collection {
        display: block;
        width: 100%;
        top: 60px;
        position: relative;
    }

    .preset-button:hover {
        color: white;
    }

    .preset-button {
        width: 30px;
        height: 30px;
        border: 3px solid white;
        border-radius: 5px;
        margin-left: 10px;
        margin-right: 10px;
        transition: 0.15s linear all;
        vertical-align: top;
    }

    .preset-button:hover {
        box-shadow: inset 0px 0px 30px 0px rgba(0,0,0,0.5);
    }

    .preset-button:active {
        box-shadow: inset 0px 0px 30px 0px rgba(0,0,0,0.75);
        border-color: grey;
    }

    .preset-button.button-selected {
        border: 3px solid lime;
        box-shadow: inset 0px 0px 30px 0px rgba(0,0,0,0.75);
    }

    #pattern-rainbow-fade {
        background: #ff0000; /* Old browsers */
        background: -moz-linear-gradient(left, #ff0000 0%, #ff9f05 25%, #f2ff05 50%, #15ff05 75%, #0000ff 100%); /* FF3.6-15 */
        background: -webkit-linear-gradient(left, #ff0000 0%,#ff9f05 25%,#f2ff05 50%,#15ff05 75%,#0000ff 100%); /* Chrome10-25,Safari5.1-6 */
        background: linear-gradient(to right, #ff0000 0%,#ff9f05 25%,#f2ff05 50%,#15ff05 75%,#0000ff 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
    }

    #pattern-rainbow-fade2 {
        background-image: repeating-linear-gradient( 90deg, red, orange 10%, yellow 20%, green 30%, blue 40%, purple 50% );
    }

    #pattern-rainbow-jump {
        background-image: repeating-linear-gradient( 90deg, red, red 16%, orange 16%, orange 32%, yellow 32%, yellow 48%, green 48%, green 64%, blue 64%, blue 80%, purple 80%, purple 96% );
    }

    #pattern-music-hue {
        background: #ff0000; /* Old browsers */
        background: -moz-linear-gradient(left, #ff0000 0%, #ff9f05 25%, #f2ff05 50%, #15ff05 75%, #0000ff 100%); /* FF3.6-15 */
        background: -webkit-linear-gradient(left, #ff0000 0%,#ff9f05 25%,#f2ff05 50%,#15ff05 75%,#0000ff 100%); /* Chrome10-25,Safari5.1-6 */
        background: linear-gradient(to right, #ff0000 0%,#ff9f05 25%,#f2ff05 50%,#15ff05 75%,#0000ff 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
    }

</style>
<script type='text/javascript'>
    var colorsLocked, lastButtonPressedId;
    var socket = io.connect('http://rpi.student.rit.edu:8080');
    //var socket = io.connect('http://127.0.0.1:8080');
    var curFade = '';

    socket.on('color', function(data) {
        //console.log('Rec: '+JSON.stringify(data));
        if ('strip' in data) {
            deselectPreset();
            setLocalColor(data.strip, [data.r, data.g, data.b]);
        } else if ('id' in data) {
            deselectPreset();
            if (data.id != 'stop') {
                $('#pattern-'+data.id).addClass('button-selected');
            } else {
                //console.log("Got stop pattern message");
            }
        }
    });
    

    function setLocalColor(strip, color) {
        var elem = 'cc'+(strip+1);

        //console.log('Setting '+elem+' to '+JSON.stringify(color));

        document.getElementById(elem).style.background = rgbToHex(color[0], color[1], color[2]);
        //$('#'+elem).prop('value', rgbToHex(color[0], color[1], color[2]));
        $('#'+elem).css('color', getTextColorForBackground(color[0], color[1], color[2]));
    }

    $(document).ready(function() {
        colorsLocked = localStorage.getItem('locked');

        if (colorsLocked === 'false') {
            colorsLocked = true;
            //Reverse so the function will act naturally
        } else {
            colorsLocked = false;
        }

        lockIconClicked();
    });

    var bufferOpen = true;
    function post(data) {
        /*$.ajax({
            url: path,
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            method: method || 'post'
        }).done(function(res) {
            //console.log('Ajax posted: '+res.status);
            if (res.status == 'FAIL') {
                $('.jscolor').addClass('jscolor-error');
            } else {
                $('.jscolor').removeClass('jscolor-error');
            }
        });*/
        if (bufferOpen) {
            //console.log('Posting '+JSON.stringify(data))
            socket.emit('newcolor', data);
            bufferOpen = false;
            setTimeout(function() {
                bufferOpen = true;
            }, 100);
        }
    }

    function lockIconClicked() {
        var locked = 'locked.png',
            unlocked = 'unlocked.png';

        colorsLocked = !colorsLocked;
        $('#lock-strips').attr('src', '/assets/'+(colorsLocked?locked:unlocked));
        $('#cc2').prop('disabled', colorsLocked);
        $('#cc2').css('top', (colorsLocked?-30:30)+'px');

        localStorage.setItem('locked', colorsLocked);
    }

    function deselectPreset() {
        $('.button-selected').blur();
        return $('.button-selected').removeClass('button-selected').attr('id');
    }

    function chosePreset(id) {
        var last = deselectPreset();
        if (id !== last) {
            var submission = id.substring("pattern-".length);
            post({id: submission});
        } else {
            post({id: "stop"});
        }
    }

    function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? '0' + hex : hex;
    }

    function rgbToHex(r, g, b) {
        return '#' + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }

    function getTextColorForBackground(r, g, b) {
        var yiq = ((r*299)+(g*587)+(b*114))/1000;
        //Using a weight system for each color, determine the darkness
        var bOrW = (yiq >= 128) ? 0 : 1;
        /*var color = {};
        color.r = bOrW? 0:255;
        color.g = bOrW? 0:255;
        color.b = bOrW? 0:255;
        return color;*/
        return bOrW ? '#FFF' : '#000';
    }

    function colorUpdated(picker) {
        var color = {};
        color.r = Math.round(picker.rgb[0]);
        color.g = Math.round(picker.rgb[1]);
        color.b = Math.round(picker.rgb[2]);
        color.strip = [];

        if (colorsLocked) {
            color.strip = [0, 1];
            post(color);
        } else {
            switch (lastButtonPressedId) {
                case 'cc1':
                    color.strip = 0;
                    break;
                case 'cc2':
                    color.strip = 1;
                    break;
                default:
                    color.strip = 0;
            }
            post(color);
        }
    }

    function lastButtonPressed(button) {
        lastButtonPressedId = button;
    }
</script>
</head>
<body>
<h1>Choose a color</h1>
<div id='main'>
	<div class='flexible-space'>
		<img id='lock-strips' onclick='lockIconClicked()' title='Locks the color strips to the same color' src=''>
	</div>

	<div class='strips'>
    	<button class='strip-button jscolor {width: 225, position:"center", valueElement:null, styleElement:null, onFineChange:"colorUpdated(this)"}' id='cc1' onclick='lastButtonPressed(this.id)'>Strip 1</button>
    
    	<button class='strip-button jscolor {width: 225, position:"center", valueElement:null, styleElement:null, onFineChange:"colorUpdated(this)"}' id='cc2' onclick='lastButtonPressed(this.id)'>Strip 2</button>

        <div class='button-collection'>
            <button class='preset-button' id='pattern-rainbow-fade' onclick='chosePreset(this.id)'></button>
            <button class='preset-button' id='pattern-rainbow-fade2' onclick='chosePreset(this.id)'></button>
            <button class='preset-button' id='pattern-rainbow-jump' onclick='chosePreset(this.id)'></button>
            <!--<button class='preset-button' id='pattern-music-hue' onclick='chosePreset(this.id)'>♫</button>-->
        </div>
	</div>

	<div class='flexible-space'>
	</div>
</div>
</body>
</html>