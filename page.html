<!DOCTYPE html>
<html>
<head>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0'>
<script src='https://code.jquery.com/jquery-2.2.0.min.js'></script>
<script src='/js/jscolor.min.js'></script>
<script src='/js/socketio/socket.io.js'></script>
<script src='/js/patterns.js'></script>
<link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
<link href='/assets/style.css' rel='stylesheet' type='text/css'>
<script type='text/javascript'>
    var colorsLocked, lastButtonPressedId;
    var buttons = null;
    var loc = document.location.origin;
    var socket = io.connect(loc);
    console.log("Socket connected to",loc)
    //var socket = io.connect('http://rpi.student.rit.edu:8080');
    //var socket = io.connect('http://127.0.0.1:8080');
    var curFade = '';
    var reachable = false;


    socket.on('color', function(data) {
        //console.log('Rec: '+JSON.stringify(data));
        if ('strip' in data) {
            deselectPreset();
            setLocalColor(data.strip, [data.r, data.g, data.b]);
        } else if ('id' in data) {
            deselectPreset();
            if (data.id != 'stop') {
                choosePreset(data.id, data.config);
            } else {
                removeConfig();
                console.log("Got stop pattern message");
            }
        }
    });

    socket.on('connect', function() {
        console.log("Connected");
        reachable = true;
        disableButtons(false);
    });

    socket.on('disconnect', function() {
        reachable = false;
        disableButtons(true);
    });

    socket.on('error', function(err) {
        reachable = false;
        console.err(err);
    });
    
    function disableButtons(enabled) {
        if (!buttons) {
            buttons = $("button.jscolor");
        }
        if (enabled) {
            buttons.each(function(idx) {
                $(this).addClass("offline");
                $(this).prop("disabled", true);
            })
        } else {
            buttons.each(function(idx) {
                $(this).removeClass("offline");
                $(this).prop("disabled", false);
            })
        }
    }

    function setLocalColor(strip, color) {
        var elem = 'cc'+(strip+1);

        //console.log('Setting '+elem+' to '+JSON.stringify(color));

        document.getElementById(elem).style.background = rgbToHex(color[0], color[1], color[2]);
        //$('#'+elem).prop('value', rgbToHex(color[0], color[1], color[2]));
        $('#'+elem).css('color', getTextColorForBackground(color[0], color[1], color[2]));
    }

    $(document).ready(function() {
        colorsLocked = localStorage.getItem('locked');

        if (colorsLocked === 'false') {
            colorsLocked = true;
            //Reverse so the function will act naturally
        } else {
            colorsLocked = false;
        }

        disableButtons(false);

        lockIconClicked();
    });

    var bufferOpen = true;
    function post(data) {
        /*$.ajax({
            url: path,
            data: JSON.stringify(data),
            dataType: 'json',
            contentType: 'application/json',
            method: method || 'post'
        }).done(function(res) {
            //console.log('Ajax posted: '+res.status);
            if (res.status == 'FAIL') {
                $('.jscolor').addClass('jscolor-error');
            } else {
                $('.jscolor').removeClass('jscolor-error');
            }
        });*/
        if (bufferOpen) {
            //console.log('Posting '+JSON.stringify(data))
            socket.emit('newcolor', data);
            bufferOpen = false;
            setTimeout(function() {
                bufferOpen = true;
            }, 100);
        }
    }

    function lockIconClicked() {
        var locked = 'locked.png',
            unlocked = 'unlocked.png';

        colorsLocked = !colorsLocked;
        $('#lock-strips').attr('src', '/assets/'+(colorsLocked?locked:unlocked));
        $('#cc2').prop('disabled', colorsLocked);
        $('#cc2').css('top', (colorsLocked?-30:30)+'px');

        localStorage.setItem('locked', colorsLocked);
    }

    function deselectPreset() {
        $('.button-selected').blur();
        return $('.button-selected').removeClass('button-selected').attr('id');
    }

    //Called by external preset updating
    function choosePreset(id, options) {
        $('#pattern-'+id).addClass('button-selected');
        var config = options || patterns[id].config;
        if (config) {
            setupConfig(config);
        }
    }

    function chosePreset(id) {
        console.log("Preset: "+ id);
        if (!reachable) {
            return;
        }
        var last = deselectPreset();
        if (id !== last) {
            var submission = id.substring("pattern-".length);
            //setupConfig(patterns[submission].options || null);
            post({id: submission});
        } else {
            removeConfig();
            post({id: "stop"});
        }
    }

    function componentToHex(c) {
        var hex = c.toString(16);
        return hex.length == 1 ? '0' + hex : hex;
    }

    function rgbToHex(r, g, b) {
        return '#' + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }

    function getTextColorForBackground(r, g, b) {
        var yiq = ((r*299)+(g*587)+(b*114))/1000;
        //Using a weight system for each color, determine the darkness
        var bOrW = (yiq >= 128) ? 0 : 1;
        return bOrW ? '#FFF' : '#000';
    }

    function colorUpdated(picker) {
        var color = {};
        color.r = Math.round(picker.rgb[0]);
        color.g = Math.round(picker.rgb[1]);
        color.b = Math.round(picker.rgb[2]);
        color.strip = [];

        if (colorsLocked) {
            color.strip = [0, 1];
            post(color);
        } else {
            switch (lastButtonPressedId) {
                case 'cc1':
                    color.strip = 0;
                    break;
                case 'cc2':
                    color.strip = 1;
                    break;
                default:
                    color.strip = 0;
            }
            post(color);
        }
    }

    function lastButtonPressed(button) {
        lastButtonPressedId = button;
    }

    /*

    Config Space

    */

    function rangeAdjusted(item, toUpdate) {
        if (toUpdate && toUpdate.length>0) {
            var elem = document.getElementById(toUpdate);
            elem.innerText = item.value + "%";
        }
    }

    function rangeSet(element) {
        post({
            config: element.id,
            value: parseInt(element.value)
        });
    }

    function checkboxSet(element) {
        post({
            config: element.id,
            value: element.checked
        });
    }

    function removeConfig() {
        var container = document.getElementById("config-space");
        if (!$(container).is(":visible")) {
            return;
        }
        $(container).slideUp(400);
        setTimeout(function() {
            $(container).empty();
        }, 400);
    }

    function setupConfig(options) {
        var container = document.getElementById("config-space");
        if (!options) {
            removeConfig();
            return;
        } else if ($(container).is(":visible")) {
            $(container).empty();
        }
        var option, config;
        for (var index in options) {
            option = options[index];
            config = option.config;
            var rowElem = document.createElement("div");
            rowElem.className = "config-item-row";
            var lLabel = document.createElement("span");
            var rLabel = document.createElement("span");
            lLabel.className = "config-item item-left";
            rLabel.className = "config-item item-right";
            var elem = document.createElement("input");
            elem.type = config.input.type;
            if (config.label.left) {
                lLabel.id = config.label.left.id;
                lLabel.innerText = config.label.left.text;
            }
            if (config.label.right) {
                rLabel.id = config.label.right.id;
                if (config.input.valueType && config.input.valueType === "percent" && option.displayValue != null) {
                    rLabel.innerText = option.displayValue + "%";
                } else {
                    rLabel.innerText = config.label.right.text;
                }
            }

            elem.id = index;
            elem.toChange = (config.label.right && config.label.right.id) || null;
            
            if (config.input.type == "range") {
                if (elem.toChange) {
                    elem.addEventListener("input", function(event) {
                        rangeAdjusted(event.target, event.target.toChange);
                    });
                }

                elem.addEventListener("change", function(event) {
                    rangeSet(event.target);
                });

                if (option.displayValue != null) {
                    elem.setAttribute("value", option.displayValue);
                }

                if (config.input.range != null) {
                    elem.setAttribute("min", config.input.range.min);
                    elem.setAttribute("max", config.input.range.max);
                }
            } else if (config.input.type == "checkbox") {
                elem.addEventListener("change", function(event) {
                    checkboxSet(event.target);
                });
                if (option.displayValue != null) {
                    //elem.setAttribute("checked", option.displayValue);
                    elem.checked = option.displayValue;
                }
            }

            
            rowElem.appendChild(lLabel);
            rowElem.appendChild(rLabel);
            rowElem.appendChild(elem);
            container.appendChild(rowElem);
        }
        $(container).slideDown(400);
    }
</script>
</head>
<body>
<h1>Choose a color</h1>
<div id='main'>
	<div class='flexible-space'>
		<img id='lock-strips' onclick='lockIconClicked()' title='Locks the color strips to the same color' src=''>
	</div>

	<div class='strips'>
    	<button class='strip-button jscolor {width: 225, position:"center", valueElement:null, styleElement:null, onFineChange:"colorUpdated(this)"}' id='cc1' onclick='lastButtonPressed(this.id)'>Strip 1</button>
    
    	<button class='strip-button jscolor {width: 225, position:"center", valueElement:null, styleElement:null, onFineChange:"colorUpdated(this)"}' id='cc2' onclick='lastButtonPressed(this.id)'>Strip 2</button>

        <div class='button-collection'>
            <button class='preset-button' id='pattern-rainbow-fade' onclick='chosePreset(this.id)' title="Rainbow Fade"></button>
            <button class='preset-button' id='pattern-rainbow-alternate' onclick='chosePreset(this.id)' title="Reverse Double Fade">
                <div id='pattern-rainbow-alternate-top'></div>
                <div id='pattern-rainbow-alternate-bottom'></div>
            </button>
            <!--<button class='preset-button' id='pattern-music-hue' onclick='chosePreset(this.id)'>♫</button>-->
            <button class='preset-button' id='pattern-random' onclick='chosePreset(this.id)' title="Random">?</button>
            <button class='preset-button' id='pattern-waves' onclick='chosePreset(this.id)' title="Waves">
                <span id='pattern-waves-text'></span>
                <div id='pattern-waves-circle-red' class='pattern-waves-circle'></div>
                <div id='pattern-waves-circle-green' class='pattern-waves-circle'></div>
                <div id='pattern-waves-circle-blue' class='pattern-waves-circle'></div>
            </button>
            <button class='preset-button' id='pattern-moving-fade' onclick='chosePreset(this.id)' title="Moving Fade"></button>
            <button class='preset-button' id='pattern-switch' onclick='chosePreset(this.id)' title="Switch"></button>
        </div>

        <div id='config-space'>
        </div>
	</div>

	<div class='flexible-space'>
	</div>
</div>
</body>
</html>